pipeline {
    agent any

    options { skipDefaultCheckout() }

    stages {

        stage('Get Code') {
            steps {
                deleteDir()
                withCredentials([usernamePassword(
                    credentialsId: 'github-pat',
                    usernameVariable: 'GH_USER',
                    passwordVariable: 'GH_PAT'
                )]) {
                    sh '''
                        set -e
                        git clone --branch master https://$GH_USER:$GH_PAT@github.com/alvaro-unir/todo-list-aws.git .
                    '''
                }
                stash name: 'code', includes: '**'
            }
        }

        stage('Deploy Production') {
            agent { label 'built-in' }

            steps {
                deleteDir()
                unstash 'code'

                sh '''
                    set -e
                    sam build
                    sam deploy --config-env production
                '''

                script {
                    def baseUrl = sh(
                        script: '''
                            aws cloudformation describe-stacks \
                              --stack-name todo-list-aws-production \
                              --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
                              --output text
                        ''',
                        returnStdout: true
                    ).trim()

                    writeFile file: 'base_url.txt', text: baseUrl
                }

                stash name: 'envinfo', includes: 'base_url.txt'
            }
        }

        stage('Rest Test Production') {
            agent { label 'rest-test' }

            steps {
                deleteDir()
                unstash 'code'
                unstash 'envinfo'

                sh '''
                    set -e
                    export BASE_URL="$(cat base_url.txt)"
                    echo "BASE_URL=$BASE_URL"
                    pytest test/integration/todoApiTest.py
                '''
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
